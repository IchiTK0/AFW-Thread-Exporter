# ....................................................................................................
# .  ....... ...     ......... ... ... ..... ...  .....  ... ... ... ... ... ...       ..... ... .... 
# .  .---------------------------------------------------------------------------------------------.. 
# .  .=============================================================================================:. 
# .  .=================-::::::::-====================:.........:-============-.........:-==========:. 
# .  .================-..........-================:....        ....:-=====-......       ....-======:. 
# .  .================:.        ..-=============-....            ..:====-....             .:=======:. 
# .  .===============:..         ..-===========-..      ..........:====-...    ...........:========:. 
# .  .==============-...          .:===========...     .-=====--::=====:.     ..:-====--::=========:. 
# .  .=============-..     ...    ..-==========...     .===============:.     ..-==================:. 
# .  .=============:..    .::..    ..-=========...     ..-=============..      ..-=================:. 
# .  .============-.     ..-=:.     .:=========...        ...:-========:.         ...:--===========:. 
# .  .===========-.     ..:==-..     .-========-....           ...-====-...             ..-========:. 
# .  .===========:.     .:====:.     ..-=========:..             ...-====-...            ...:======:. 
# .  .==========:...   ..-====-:.     ..============-:....         ..-======-:....         ..-=====:. 
# .  .=========-....   ..------:..    ..-================--..       .:===========--:..      ..=====:. 
# .  .=========...         ... ...      .-==================-.      .:==============-..      .=====:. 
# .  .========:...                      ..======-.:=========-.      .:==-::-========-...    .:=====:. 
# .  .=======-.      ...............     .:====-.....:-----:..     ..-=-.....:-----:...     .-=====:. 
# .  .======-...    ..-===========:..     .-==-..............     ..:=-...........         .:======:. 
# .  .======:.     ..-============-..     ..==....             ....:==:...               ..:=======:. 
# .  .=====:..     .:==============-.. ... .:===:...         ....-======:...           ..-=========:. 
# .  .===============================================-:....:-================-:....::-=============:. 
# .  .====-...:=====:..:=====:...:........===========:......:=====-....-=====:...-======:...-======:. 
# .  .=====....====-....-===:...::........-========:....  ...====-... .:=====:. ..:-====:...-======:. 
# .  .=====-...:==-..  .:==-:...-:. .-============....:-==--:====:......:====:.  ...-===:. .-======:. 
# .  .======....-=:......-=:...-=:. .::::-=======....:==========-...::...-===:.......:==:. .-======:. 
# .  .======-. .:-...::..:-...:==:. ......-======.. .==========-....=-....-==:. .--....-:. .-======:. 
# .  .=======:......:=-.......-==:. .-===========:...:=========.. .::::. .:==:. .-==:..... .-======:. 
# .  .=======-..  ..-==:.   .:===:. .:-===========.....:==-..=:.......... .:=:...-===-...  .-======:. 
# .  .========:. ..:===-.. ..-===:.      .-========-:#@@@@@%=-. ..=====-....-:. .-====-..  .-======:. 
# .  .=========---=======---======--------=======*%%=%%==#-:%%+--========---==---========---=======:. 
# .  .=========================================#%**#%@@#%#*%#+*#===============-----===============:. 
# .  .=======================================#%#%@@@@@@@@@@@%%%%%*=============----==--------======:. 
# .  .======================================*%%@@#*=--====++*##@@%+=========------====--===-=======:. 
# .  .======================================%*%%*-...:-----+++**@%#====================-===========:. 
# .  .======================================%@%#+....::---=++*#*+@%================================:. 
# .  .======================================%@%%*=..  ..---++*#+-%%+===============================:. 
# .  .======================================%@%##=-.....:.--:-+***%+===============================:. 
# .  .======================================#@%+:#%##@@+--%@%%@%##%+===============================:. 
# .  :*************************************%@@%-+==%%***:#@@%@@%#+@#*******************************:. 
# .  :************************************%%###=::++===:-*#******=%%*******************************:. 
# .  :************************************##+##+-...:-=.-#******+=%%*******************************:. 
# .  :*************************************%#-##*++..+=++##%#****=%%#******************************:. 
# .  :**************************************##%%*-..=*-##*#*%**#%+@%*******************************:. 
# .  :****************************************%#+-.:+:-++###*#*##%%********************************:. 
# .  :****************************************##*:.::#%***%@%#*#=%#********************************:. 
# .  :*****************************************%#=.:=:-:+#%+#*+-@%*********************************:. 
# .  :*****************************************%%*=-.----#***+-@%**********************************:. 
# .  :*****************************************#*%#+--+%@%##*=%#%**********************************:. 
# .  :****************************************#%**@%%*##***==%%+%%#********************************:. 
# .  :**********************************#######*--+#%@@###%%@@%+#++++##****************************:. 
# .  :*******************************#*=:.=%@#+-..:=+#*#%%%#%@#=*****==*+*#************************:. 
# .  :***********************#########:. .+%%=-:...-=*%*%@@#%%*--+****#+..:+##*********************:. 
# .  :******************##%%%%%%#***#%+-..*#=:.....--%*##*%#%%+----+*#*...-#*+#********************:. 
# .  :***************#%%%*+=--+++**+*###**+%%+:....-*#%%#%@@@#*+=::=%*:..-+:-=-*%##****************:. 
# .  :*************#%%*+=-:..:-==*####%%%#-***%%%*---%@#@@@@@@%#***#+...-#=.-*#++=---*##***********:. 
# .  :***********#%#*+--:....:---*####%%%-:.#@@@@@@---%*@@#@##*:=*#::-=-=**-=%@#**+==+++*#*********:. 
# .  :*********#%%*+=--:..  ..---+==#%*%-.:-#@@@@@@*++**%@#***###=::.=%#*-...:::::+=::=*+*#********:. 
# .  :*******#%@%#+=--:...  ..:-+-=###**+++=#+*%@%@*+++##@#*#%%#:::...-========+*+**:.:+*++********:. 
# .  :***##%%###**+=--:.....::=**=*##%%#%@%+*-+%%@*++*#%*@##=::++... .-###=::...::=*-.:=**-********:. 
# .  :####+=-:.........:::---+*#=+#%=*#%@%*=*-#@%@@%+::%*@#%-::=*..   .:*#=:--=+**+*-.:+**-=#******:. 
# ..-+#+=:..:--======+++++=-----=#%+*#%@#+--#:+%%@@@+--#%%%%=--:==.    .-##=-::-:::+*--+**=-##*****:. 
# :#*+=:..:----++**#%%%#*++=-:==*#%##%%*=:.*#:+%#@@%+---%=%##%%=-*.     .-#*++++++##%%*++*+=*#*****:. 
# *+=-.........:--==++*#%%*+++=+#%%%%%*-..:%+:+%@@#+-:..%=%#*#@#:=-.     .-#@@@@#***%@@%=-+***#****:. 
# =--..        ...:---+*#@@%##%%%*##%*:...#@-:*@@@#+:. .%=%@*##@*-*.      ..=%@%%#*%@#%@%-.:=*=#***:. 
# -:..          ..:--=+*%@%**#@@@%**#=...=%%:-#@@@#=.. .%*%@@%%%%-==.      ..:*@%%%*##%###:.:=*+##*:. 
# -...         ...--=+###*#%%%@#%@@@*:..:#*%:=#@%@*=.  .%@@@@@%#@#-+:.      .-*#%@#+*##*#*++--+*++#:. 
# -:..        ..:-=*###****%@@%+#%%@#:..*%-*:+%@%@*=.  .#%%@@@#*#%*-+.     .-**#%%%*+#%%*+=-=++##*=+..
# ----::::::::-+*##********#@%+=#%@@#:.+%=.==-*%%@#+.  .%##@@%--#%#==-.  ..-+**#%%@@@@@#*+++=---=***+.
# -=======++*##************#%+-**####-=%*:..-*#@@@#=.  .%##%%*..=#@#=+....-=***#@@@%%%@@#*++++=:..-=*+
# *######%%#***************#*==*+##+#=#%-...:#-#@@#=.  .%##%#-...*#%+=-:------+*%@@@#%@@@%*+++++=:..--
# :::-=+++*##**************#*-*+=##*#%@+.. .=*:#@@%+.  .%##%+=. .:#%#=*-------=+*%@@%#%@@@@#*+++++--*=
# .  ..:-++*##*************%%#+::##+%@#=....#-=#@@@+....%###:#....-#@#+=-------=**#%@##%@@@@@*++++++-*
# .     .:=+*%#***********##%%=.:#*-#@+--...*:+#@@@+-:..%###:*:.:-=*#%#*-------=*+*##%#%@@@@@@%*++++++
# ..    ..-+*%@%**********####=.:##-#%-....*-.**%@@*=--:%###:=*----=#%%*-------=+*#***%##%@@@@@@#++++-
# --:.. ..:=*#**##********##%@+::##+##-....#:.#+#@@*=---%###==#-----+#@%+--:...-*##****%%##%##%@%*++++
# +=--:...:===-=+*#*-:::::+++%*-:##+#%+-:.==..*:#@%=:..:%###+=#-----=*#@#:....:=#+::::::=*##**#%@%*+++
# %#*=---:......:=+**+:..:=+==#=-##-#%+-::#:..-:*%*-.  .%##**=#------+%%#+: .:-*#-.     ...-+##**%*+++

##################################################################################################

DEFAULT_POST_WIDTH_PX = None
DEFAULT_POST_ALIGNMENT = "center"
DEFAULT_OUTPUT_FILENAME = "Thread"
DEFAULT_OUTPUT_FILETYPE = "pdf"

##################################################################################################

import os
os.environ["SCRAPY_SETTINGS_MODULE"] = "CrawlPhpBbThread.settings"

from scrapy.crawler import CrawlerProcess
from scrapy.utils.project import get_project_settings
from CrawlPhpBbThread.spiders.phpBbSpiders import PhpBbThreadSpider

def _validate_and_process_arguments(_THREAD_URL_INPUT, _POST_WIDTH_PX, _POST_ALIGNMENT, _OUTPUT_FILENAME, _OUTPUT_FILETYPE):
    def _validate_string_argument(arg_name, arg_str, valid_str_options_arr):
        opts_str = ','.join([f"'{x}'" for x in valid_str_options_arr])
        error_msg_str = f"Invalid input for '{arg_name}'.  Must be a string with one of the following values: [{opts_str}]"
        if not isinstance(arg_str, str):
            raise Exception(error_msg_str)
        arg_str = arg_str.lower()
        if arg_str not in valid_str_options_arr:
            raise Exception(error_msg_str)
        return arg_str

    try:
        # There is probably a more elegant way of verifying that the parameters are valid, but since I'm operating on no sleep, I'll accept the possibility that I'll' give Henry Henderson of Eden Academy heart palpitations with my inelegant approach.

        thread_url_error_msg_str = "Invalid input for 'thread_url'.  A URL must be specified."
        if _THREAD_URL_INPUT is not None:
            if not isinstance(_THREAD_URL_INPUT, str):
                raise Exception(thread_url_error_msg_str)
            if len(_THREAD_URL_INPUT) <= 0:
                raise Exception(thread_url_error_msg_str)
            _THREAD_URL = _THREAD_URL_INPUT
        else:
            raise Exception(thread_url_error_msg_str)

        if _POST_WIDTH_PX is not None:
            try:
                _POST_WIDTH_PX = float(_POST_WIDTH_PX)
            except ValueError:
                raise Exception("Invalid input for 'post_width_px'.  Must be a number.")
        else:
            # Unless _DEFAULT_POST_WIDTH_PX is changed to a value other than None, this is thoroughly redundant.
            _POST_WIDTH_PX = DEFAULT_POST_WIDTH_PX

        if _POST_ALIGNMENT is not None:
            _POST_ALIGNMENT = _validate_string_argument("POST_ALIGNMENT", _POST_ALIGNMENT, ['left','center','right'])
        else:
            _POST_ALIGNMENT = DEFAULT_POST_ALIGNMENT

        if _OUTPUT_FILETYPE is not None:
            _OUTPUT_FILETYPE = _validate_string_argument("OUTPUT_FILETYPE", _OUTPUT_FILETYPE, ['pdf','html'])
        else:
            _OUTPUT_FILETYPE = DEFAULT_OUTPUT_FILETYPE

        # My spy senses suspect that this is the crescendo of my inelegance.
        if _OUTPUT_FILENAME is not None:
            if not isinstance(_OUTPUT_FILENAME, str):
                raise Exception("Invalid input for 'OUTPUT_FILENAME'.  Must be a string.")
            if len(_OUTPUT_FILENAME) <= 0:  # Loid had his multiple outfits ready for the entrance test.  I'm preparing for a stray particle to flip the right bit(s) to make length negative.
                _OUTPUT_FILENAME = DEFAULT_OUTPUT_FILENAME
            elif (_OUTPUT_FILENAME[-4:] == '.pdf'):
                if (_OUTPUT_FILETYPE == "pdf"):
                    _OUTPUT_FILENAME = _OUTPUT_FILENAME[:-4]
                else:
                    # Odd choice, but who am I to judge?
                    pass
            elif (_OUTPUT_FILENAME[-5:] == '.html'):
                if (_OUTPUT_FILETYPE == "html"):
                    _OUTPUT_FILENAME = _OUTPUT_FILENAME[:-5]
                else:
                    # Odd choice, but who am I to judge?
                    pass
            else:
                # Technically redundant, but I'm deciding to spell things out.
                pass
        else:
            _OUTPUT_FILENAME = DEFAULT_OUTPUT_FILENAME

    except Exception as e:
        return e, None, None, None, None, None
    else:
        return None, _THREAD_URL_INPUT, _POST_WIDTH_PX, _POST_ALIGNMENT, _OUTPUT_FILENAME, _OUTPUT_FILETYPE
    

def get_input(prompt):
    print(prompt)
    s = input("> ")
    return s if len(s) > 0 else None

settings = get_project_settings()
while True:
    print("####################################################################################################")
    print("    AFWRPG Thread to PDF/HTML Exporter")
    print("####################################################################################################")
    THREAD_URL_INPUT = get_input("Enter the URL of the first page of the target thread:")
    POST_WIDTH_PX_INPUT = get_input("Enter the desired post display width in pixels:\t\t(Default: Fit width [press enter])")
    POST_ALIGNMENT_INPUT = get_input(f"Enter the desired post alignment:\t\t\t(Options: left,center,right | Default: {DEFAULT_POST_ALIGNMENT} [press enter])")
    OUTPUT_FILENAME_INPUT = get_input(f"Enter the desired output filename:\t\t\t(Default: {DEFAULT_OUTPUT_FILENAME} [press enter])")
    OUTPUT_FILETYPE_INPUT = get_input(f"Enter the desired output filetype:\t\t\t(Options:html,pdf | Default: {DEFAULT_OUTPUT_FILETYPE} [press enter])")
    exception_object, THREAD_URL, POST_WIDTH_PX, POST_ALIGNMENT, OUTPUT_FILENAME, OUTPUT_FILETYPE = _validate_and_process_arguments(THREAD_URL_INPUT, POST_WIDTH_PX_INPUT, POST_ALIGNMENT_INPUT, OUTPUT_FILENAME_INPUT, OUTPUT_FILETYPE_INPUT)
    if exception_object is None:
        print("")
        break
    print(f"Argument error! : {exception_object}")
    input("Restarting...press enter to continue.")
    print("\n\n")

settings.set("POST_WIDTH_PX", POST_WIDTH_PX, priority='cmdline')
settings.set("POST_ALIGNMENT", POST_ALIGNMENT, priority='cmdline')
settings.set("OUTPUT_FILENAME", OUTPUT_FILENAME, priority='cmdline')
settings.set("OUTPUT_FILETYPE", OUTPUT_FILETYPE, priority='cmdline')

process = CrawlerProcess(settings)
process.crawl(PhpBbThreadSpider, start_urls = [THREAD_URL])
process.start()

print("\nYou should see a success message above if the program was successful.")
print("If you do not see that message, then the program likely encountered an error.")
print("In that case, please double check that the URL you entered is valid.")
print("Afterwards, restart the program.\n")